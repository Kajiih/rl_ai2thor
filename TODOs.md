# TODOs and in coming features

## Possible features

- Add falling back on closest object to the agent if no object at the target coordinates
- Add falling back on closest object in the agent's field of view if no object at the target coordinates
- If no object is at the target object coordinates, add range around the coordinates to search for the object
- Add continuous/discrete dichotomy for some action groups only
- Add 3rd party/external camera
- Add enabling or disabling object properties from config (`openable`, `pickupable`, `receptacle`, ...)
- Add switching from on and off toggle actions to single toggle action from config

## **TODOs**

### Dev TODOs

- [x] Test enabling cloud rendering from config
- [ ] Test with the `startx.py` script and add it to the README if necessary
- [ ] Create a docker image to simplify the Xorg setup

- [ ] Add indirect candidate requirement for certain item prop (`water_source` necessary when `dirty=True`). Eventually make it at the same time than adding intermediate goals (toggling a `water_source`)
  - [ ] `VISIBLE` -> some dense reward function of the distance to the object and the angle to the object in the field of view
  - [x] `IS_TOGGLED` -> None
  - [x] `IS_BROKEN` -> ~~None?~~ Pick up?
  - [x] `IS_FILLED_WITH_LIQUID` -> toggle a `water_source`?
  - [ ] `FILL_LIQUID` -> IS_FILLED_WITH_LIQUID
  - [x] `IS_DIRTY` -> toggle `water_source` if `IS_DIRTY=True`? else **not** possible
  - [x] `IS_USED_UP` -> None
  - [x] `IS_COOKED` -> toggle and/or open a compatible `cooking_source`? and pick up the `cooked` item?
  - [x] `TEMPERATURE` -> toggle and/or open a compatible `heat_source` if `HOT` or `cold_source` if `COLD`?
  - [x] `IS_SLICED` -> pickup `knife`
  - [x] `IS_OPEN` -> None
  - [x] `OPENNESS` -> None
  - [x] `IS_PICKED_UP` -> None
  - Nothing needed for fixed properties
  - The new auxiliary items generated by the intermediate goals can overlap with the original items (one candidate can work for several)
  - [ ] Add indirect candidate requirement for certain relations
    - [ ] `RECEPTACLE_OF` -> open the receptacle if it is closed in the beginning
    - [x] `CONTAINED_IN` -> None
    - [x] `CLOSE_TO` -> None
  - [ ] Add other indirect intermediate tasks (like the need to open a container if the all the candidates for an item are in the container)
- [ ] Implement contextual interactions for auxiliary goals (liquid fill (coffee with coffee machine...), cooking (bread slice in toaster...), heating (mug in coffee machine...), slicing (breaking) eggs without knife)
- [ ] Intermediate/auxiliary goals with custom property satisfaction function being: the goal auxiliary goal is satisfied OR the main goal is satisfied (property satisfied or relation satisfied)
  - [x] Implement auxiliary properties for properties
  - [x] Implement auxiliary items for properties
  - [x] Implement auxiliary properties for relations
  - [ ] Implement complex auxiliary properties (e.g. you need to open the microwave then put potato in then close the microwave then toggle the microwave to cook the potato...)

- [ ] Support slicing/cracking objects (`objectType` changes when slicing)
  - [x] Using `MultiValuePSF` with both sliced and basic object types
  - [ ] Automatically changing the `ObjectType` from SingleValuePSF to MultiValuePSF when object has to be sliced/cracked
  - [ ] Implement the fact that one object can become multiple objects and so some tasks are compatible even if some overlap class have no valid assignment because some sliceable object can count several times after slicing.
- [ ] Support different liquids (coffee for mugs)
- [x] Implement a task parser for dictionary that takes a dictionary defining a task with strings and return the correct task dictionary

- [x] In TaskItem class, separate FixedItemProp which are used only as candidate required property and the variable props which are used only for advancement computation
- [x] Same with specific TaskItems for auxiliary items
- [x] Same with specific ItemProp for auxiliary prop
- [x] Use a NewType for candidate id
- [x] Stop using generic type [T] in TaskItem

- [ ] Implement a more general item prop class that doesn't directly depend on an ai2thor object's property
- [x] Change `OBJECT_TYPES_DATA` to be a dataclass
- [x] Delete the main and related item information from the relations initialization
- [ ] Implement a way to define tasks directly from config with task dictionaries
- [ ] Add an order to item properties and relations (only properties?) so that the agent doesn't receive reward for a property of order n if all properties of orders n-1 of the item are not satisfied
- [ ] Implement the fact that relations count only if the all properties of both items are satisfied (both in the task advancement and the computation of the task advancement bounds)
- [ ] Change name of the project and package to RL THOR or THORRL?
- [ ] Make compatible with python 3.11 (and 3.10?) and update README installation part
- [x] Add Gymnasium interface
- [x] Create iTHOR environment class

- [ ] Refactor envs.tasks.tasks.py by using only item ids as dictionary key instead of sometimes the ids and sometimes the item itself
- [x] Refactor results and scores in envs.tasks.tasks.py to use 2 different dicts for relations and properties instead of 1 common dict to simplify types
- [ ] Add checking if actions are compatible with each other
  - [ ] Can't be 100% accurate, but we can do some checks (e.g.`hand_movements` implies `pickup`, ...)

  - [ ] Handle sliced items in tasks

    - [ ] In candidate objects

  - [ ] Add FlattenActionWrappers

    - [ ] Handle render modes

  - [`ToTest`] Implement target object through position
  - [ ] Add scene id handling at reset
  - [ ] Implement gray scale image mode
  - [`ToTest`] Implement variable openness
  - [`ToTest`] Handle default parameter value for actions

    - [`ToTest`] Handle changing default parameter value from config

  - [ ] Handle actions without arguments (in compute_compatible_task_args)
  - [ ] Create context manager to automatically close AI2-THOR window
  - [ ] Handle done actions
  - [x] Add reward
  - [ ] Find a way to add dense reward meaningfully
  - [x] Add reward for task completion
  - [ ] Handle episode termination (task success/failure)
  - [x] Handle truncation (timeout)
  - [ ] Handle depth frame and instance segmentation frame
    - [ ] Add other third party camera? see: <https://colab.research.google.com/github/allenai/ai2thor-colab/blob/main/templates/AI2_THOR_Full_Starter_Template.ipynb#scrollTo=QzRmqnLfMs6D>
    - [ ] Add top down view with third party camera?
  - [ ] Handle data saving from config
  - [ ] Handle step info better
  - [x] Check seed, randomization and reproducibility
  - [x] Handle reset at the end of the episode
  - [ ] Update docstring and documentation
  - [ ] Make `gridsize` and `moveMagnitude` parameters coherent (for `MoveAhead`-type actions)
  - [ ] Make the whole framework split-aware ('train', 'test' splits, ...)
  - [ ] Add some non-navigation **mode**? Where the agent can teleport while pointing at where it wants to go
  - [x] Add parameters to relations and properties
  - [ ] Improve config (and environment mode config) handling
  - [ ] Add support for multitask with different information than text description (like index of task in a list (+index of target object types...?))
  - [x] Add Single task wrapper instead?
  - [x] Add normalize wrapper that normalizes observation (should not be needed) and actions: [-1, 1] for continuous
  - [x] Make wrapper to change obs from channel last to channel first
  - [ ] TODO: Improve environment registering (kwargs, wrappers..)
  - [ ] Make automatic version handling for the package and the environment register
  - [ ] Make Grayscale wrapper
  - [ ] Make some wrapper being the default behavior
  - [ ] Test combined wrappers
  - [ ] Change example scripts to jupyter notebooks
  - [ ] Add frame stacking
  - [ ] Add more SB3 algorithms
  - [ ] Add graph visualization with pygraphiz (does it need networkx?)

- [ ] Add an update/reset candidates method to GraphTask so it is possible to use graph tasks without using compute_task_advancement at each step to update the candidates when necessary

  - [ ] ManipulaTHOR env
  - [ ] RoboTHOR env

- [ ] Add RL algorithms

  - [ ] Support Stable Baselines3
  - [ ] Support RLlib..?
  - [ ] Support CleanRL

### Code Improvement TODOs

- [ ] Add SimObjectMetadata class to have more type safety when using the object's metadata?
- [ ] Add TaskInfo dataclass instead of returning a dictionary in compute_task_advancement
- [ ] Implement equality test of tasks, items, relation, properties
- [ ] Add decoupling prop/relations and relation interfaces/relations and relation and relation/inverse relation
- [ ] Add a separate class for actions with target object
- [ ] Add specific action classes for each action group (like `OpenCloseEnvAction`)

### Test TODOs

- [ ] Test CustomGraphTask Class
- [ ] Test each environment actions

### Bug TODOs

- [x] Check the problem with no scene compatible with `PrepareMeal` task (no egg object..?)

#### AI2THOR related

- [ ] An object contained in a receptacle that is picked up is not considered in the receptacle anymore while this one is picked up (but it is the case again when the receptacle is put down)
  - Similar problem described in this [issue](https://github.com/allenai/ai2thor/issues/1209)
- [ ] Opening or closing blinds in `FloorPlan301` (`Bedroom`) makes the environment crash because of a timeout error. Also happens on `FloorPlan302` (`Bedroom`) and `FloorPlan15` (`Kitchen`) and probably all scenes with `Blinds`.
  - I opened this [issue](https://github.com/allenai/ai2thor/issues/1213)
- [ ] We can't put a `CrackedEgg` in a `Plate`, `Pan` and maybe other receptacles. Apparently there's not enough space for it but it works correctly when putting the not broken `Egg` and then breaking it.
  - Inconsistent but apparently expected behavior: see this [issue](https://github.com/allenai/ai2thor/issues/631)

```bash
Error encountered when running action {'action': 'OpenObject', 'objectId': 'Blinds|+00.11|+02.34|-01.44', 'forceAction': True, 'sequenceId': 19} in scene FloorPlan301_physics.
```

### Benchmark TODOs

- [x] Add Agent position and rotation
- [x] Create train script with command line arguments
- [ ] Add callbacks to:
  - [ ] Stop training if no improvement for a long time
  - [ ] Stop training when the model reaches the optimal task advancement
  - [x] Evaluate the model every x epochs
  - [ ] Checkpoint the model every x steps
  - [ ] Checkpoint the n best models
    - [x] Top 1 best model during eval
    - [ ] Top n best models during training
- [ ] Add training parameters to config (model dependant...)

### Final TODOs

- [ ] Check the different config files
- [ ] Check and remove ipdb traces
- [ ] Check and remove asserts
- [ ] Check remaining TODOs in code
- [ ] Check and remove `noqa`, `type: ignore` and `sourcery`
- [ ] Check and remove unused code
- [ ] Check and remove unused dependencies
- [ ] Check and remove unused files
- [ ] Test the framework with clean install
- [ ] Double check docstrings and comments
- [ ] Add documentation
- [ ] Add Pre-commit hooks
- [ ] Write changelog (<https://keepachangelog.com/en/1.0.0/>)
- [ ] Double check pyproject.toml file, especially dependencies
- [ ] Actually upload package to PyPI
- [ ] Test and add this as a solution for running on windows ? <https://yizhouzhao.medium.com/how-to-use-ai2thor-in-windows-f889abd7efcf>

- [ ] Create a `Known Issues` section in the `README` to list the AI2THOR related bugs.

## Interesting Github Issues

- <https://github.com/allenai/ai2thor/issues/993>
- <https://github.com/allenai/ai2thor/issues/1144>
- <https://github.com/allenai/ai2thor/issues/21>
- <https://github.com/allenai/ai2thor/issues/851>
- <https://github.com/allenai/ai2thor-docker/issues/3>
- <https://github.com/allenai/ai2thor-docker/issues/2>
- <https://github.com/allenai/ai2thor-docker/issues/14>
- <https://github.com/allenai/ai2thor-docker/issues/9>
